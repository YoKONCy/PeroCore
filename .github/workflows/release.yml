name: "Release"

on:
  workflow_dispatch:
  push:
    branches:
      - tauri

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "PeroLauncher -> target"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Prepare Embedded Python Sidecar (Windows)
        shell: pwsh
        run: |
          $PYTHON_VERSION = "3.10.11"
          $PYTHON_URL = "https://www.python.org/ftp/python/$PYTHON_VERSION/python-$PYTHON_VERSION-embed-amd64.zip"
          $TARGET_DIR = "PeroLauncher/src-tauri/python"
          
          if (!(Test-Path $TARGET_DIR)) { New-Item -ItemType Directory -Path $TARGET_DIR -Force }
          
          # 1. 下载并解压嵌入式 Python
          Write-Host "Downloading embedded Python from $PYTHON_URL..."
          Invoke-WebRequest -Uri $PYTHON_URL -OutFile "python_embed.zip"
          Expand-Archive -Path "python_embed.zip" -DestinationPath $TARGET_DIR -Force
          Remove-Item "python_embed.zip"
          
          # 2. 解除 python310._pth 的限制（让它能加载 site-packages）
          $PTH_FILE = "$TARGET_DIR/python310._pth"
          if (Test-Path $PTH_FILE) {
              Write-Host "Patching $PTH_FILE to enable site-packages..."
              $content = Get-Content $PTH_FILE
              $content = $content -replace "#import site", "import site"
              Set-Content -Path $PTH_FILE -Value $content
          }
          
          # 3. 安装依赖到该目录下的 site-packages
          $LIB_DIR = "$TARGET_DIR/Lib/site-packages"
          if (!(Test-Path $LIB_DIR)) { New-Item -ItemType Directory -Path $LIB_DIR -Force }
          Write-Host "Installing Python dependencies to $LIB_DIR..."
          pip install -r backend/requirements.txt --target $LIB_DIR --no-warn-script-location

      - name: install frontend dependencies
        run: npm install

      - name: build frontend
        run: npm run build

      - name: build tauri app
        uses: tauri-apps/tauri-action@v0.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v${{ github.ref_name }}-${{ github.run_number }}
          releaseName: "Pero Launcher ${{ github.ref_name }} (Build ${{ github.run_number }})"
          releaseBody: "Automated release from GitHub Actions (Tauri v2 + Embedded Python)."
          releaseDraft: false
          prerelease: false
          projectPath: PeroLauncher
          args: --config tauri.conf.pkg.json
