name: "Release"

on:
  workflow_dispatch:
  push:
    branches:
      - tauri

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r backend/requirements.txt

      - name: Build Python Sidecar (Windows)
        shell: pwsh
        run: |
          $BIN_DIR = "PeroLauncher/bin"
          if (!(Test-Path $BIN_DIR)) { New-Item -ItemType Directory -Path $BIN_DIR }
          
          # 打包后端，包含 assets 目录和提示词 md 文件
          cd backend
          pyinstaller --noconsole --onefile --name pero-backend --add-data "assets;assets" --add-data "services/mdp/prompts;services/mdp/prompts" --add-data "prompts;prompts" main.py
          
          # 按照 Tauri Sidecar 规范重命名并移动
          # x86_64-pc-windows-msvc 是 windows-latest 的默认目标
          Move-Item "dist/pero-backend.exe" "../$BIN_DIR/pero-backend-x86_64-pc-windows-msvc.exe" -Force
          cd ..

      - name: install frontend dependencies
        run: npm install

      - name: build frontend
        run: npm run build

      - name: build tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v${{ github.ref_name }}-${{ github.run_number }}
          releaseName: "Pero Launcher ${{ github.ref_name }} (Build ${{ github.run_number }})"
          releaseBody: "Automated release from GitHub Actions (Tauri v2 + Sidecar)."
          releaseDraft: false
          prerelease: false
          projectPath: PeroLauncher
          args: "--config tauri.conf.json"
